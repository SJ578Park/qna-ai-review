rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return request.auth != null && request.auth.token.role == 'admin';
    }

    function isOwner(uid) {
      return request.auth != null && request.auth.uid == uid;
    }

    // users 컬렉션
    match /users/{uid} {
      // 본인 읽기/쓰기 허용, 관리자 전체 읽기/쓰기 허용
      allow read: if isOwner(uid) || isAdmin();
      allow write: if isOwner(uid) || isAdmin();
    }

    // questions 컬렉션
    match /questions/{qid} {
      allow read: if true; // 공개 Q&A

      // 생성: 로그인 유저만
      allow create: if isSignedIn();

      // 수정: 소유자(작성자) 또는 관리자
      allow update, delete: if isAdmin() || (isSignedIn() && isOwner(resource.data.authorUid));

      // answers 서브컬렉션
      match /answers/{aid} {
        allow read: if true;

        // 답변 작성: 로그인 유저 (단, 질문이 locked 상태가 아니어야 함)
        allow create: if isSignedIn() && get(/databases/$(database)/documents/questions/$(qid)).data.status != 'locked';

        // 수정/삭제: 관리자 또는 답변 소유자
        allow update, delete: if isAdmin() || (isSignedIn() && isOwner(resource.data.authorUid));
      }
    }

    // guides 컬렉션: admin만 작성/수정, 모두 읽기
    match /guides/{gid} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }
  }
}

